<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: debug-info.php - 10up Distributor Developer Documentation</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">

	<link href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono|IBM+Plex+Sans:300,400|Playfair+Display:900&display=swap" rel="stylesheet"> 
    <link type="text/css" rel="stylesheet" href="styles-10up.css">
</head>

<body>

<div id="main">

	
    <h1 class="page-title">Source: debug-info.php</h1>
	

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>&lt;?php
/**
 * Debug information displayed in Site Health screen.
 *
 * @package  distributor
 */

namespace Distributor\DebugInfo;

use Distributor\Connections;
use Distributor\ExternalConnection;
use Distributor\InternalConnections\NetworkSiteConnection;
use Distributor\Utils;

/**
 * Setup actions and filters
 *
 * @since 2.0.0
 */
function setup() {
	add_action(
		'admin_init',
		function() {
			/**
			 * Filter whether the debug info is enabled. Enabled by default, return false to disable.
			 *
			 * @since 2.0.0
			 * @hook dt_debug_info_enabled
			 *
			 * @param {bool} true Whether the debug info should be enabled.
			 *
			 * @return {bool} Whether the debug info should be enabled.
			 */
			if ( ! apply_filters( 'dt_debug_info_enabled', true ) ) {
				return;
			}
			add_filter( 'debug_information', __NAMESPACE__ . '\add_debug_info' );
			add_action( 'admin_enqueue_scripts', __NAMESPACE__ . '\enqueue_scripts' );
		}
	);
}

/**
 * Enqueue scripts/styles for site health.
 *
 * @since  2.0.0
 *
 * @param int $hook Hook suffix for the current admin page.
 */
function enqueue_scripts( $hook ) {
	if ( 'site-health.php' !== $hook ) {
		return;
	}
	$asset_file = DT_PLUGIN_PATH . '/dist/js/admin-site-health-css.min.asset.php';
	// Fallback asset data.
	$asset_data = array(
		'version'      => DT_VERSION,
		'dependencies' => array(),
	);
	if ( file_exists( $asset_file ) ) {
		$asset_data = require $asset_file;
	}

	// Dependencies only apply to JavaScript, not CSS files.
	wp_enqueue_style( 'dt-site-health', plugins_url( '/dist/css/admin-site-health.min.css', __DIR__ ), array(), $asset_data['version'] );
}

/**
 * Add distributor debug information to Site Health screen.
 *
 * @see WP_Debug_Data::debug_data
 * @filter debug_information
 *
 * @since 2.0.0
 *
 * @param array $info The full array of site debug information.
 *
 * @return array Filtered debug information.
 */
function add_debug_info( $info ) {

	$plugin_data = get_plugin_data( WP_PLUGIN_DIR . '/' . DT_PLUGIN_FILE );
	$text_domain = $plugin_data['TextDomain'];
	$defaults    = [
		'email'                  => '',
		'valid_license'          => false,
		'license_key'            => '',
		'override_author_byline' => true,
		'media_handling'         => 'featured',
	];

	$all_settings = wp_parse_args(
		(array) get_option( 'dt_settings' ),
		$defaults
	);

	$fields = [
		[
			'label' => __( 'Version', 'distributor' ),
			'value' => $plugin_data['Version'],
		],
	];

	if ( false === DT_IS_NETWORK || is_network_admin() ) {
		$fields[] = [
			'label' => __( 'Valid registration', 'distributor' ),
			'value' => $all_settings['valid_license'] ? __( 'Yes', 'distributor' ) : __( 'No', 'distributor' ),
		];
		$fields[] = [
			'label' => __( 'Registration email', 'distributor' ),
			'value' => $all_settings['email'] ? $all_settings['email'] : __( 'N/A', 'distributor' ),
		];
	}

	$fields = array_merge(
		$fields,
		[
			[
				'label' => __( 'Settings', 'distributor' ),
				'value' => [
					__( 'Override Author Byline', 'distributor' ) => $all_settings['override_author_byline'] ? __( 'Yes', 'distributor' ) : __( 'No', 'distributor' ),
					__( 'Media Handling', 'distributor' ) => 'attached' === $all_settings['media_handling'] ? __( 'Featured image and attached images', 'distributor' ) : __( 'Featured image only', 'distributor' ),
				],
			],
			[
				'label' => __( 'Internal Connections', 'distributor' ),
				'value' => get_formatted_internal_connnections(),
			],
			[
				'label' => __( 'External Connections', 'distributor' ),
				'value' => get_formatted_external_connnections(),
			],
		]
	);

	$info[ $text_domain ] = [
		'label'  => $plugin_data['Name'],
		'fields' => $fields,
	];

	return $info;
}

/**
 * Get and format internal connections.
 *
 * @return array
 */
function get_formatted_internal_connnections() {
	if ( empty( Connections::factory()->get_registered()['networkblog'] ) ) {
		return __( 'N/A', 'distributor' );
	}

	$sites  = NetworkSiteConnection::get_available_authorized_sites( 'pull' );
	$output = [];

	foreach ( $sites as $site_array ) {
		$internal_connection  = new NetworkSiteConnection( $site_array['site'] );
		$site_name            = get_blog_option( $internal_connection->site->blog_id, 'blogname' );
		$data                 = [
			__( 'Blog ID', 'distributor' )      => $internal_connection->site->blog_id,
			__( 'URL', 'distributor' )          => get_blog_option( $internal_connection->site->blog_id, 'home' ),
			__( 'Registered', 'distributor' )   => $internal_connection->site->registered,
			__( 'Last updated', 'distributor' ) => $internal_connection->site->last_updated,
		];
		$output[ $site_name ] = format_connection_data( $data );
	}

	if ( empty( $output ) ) {
		return __( 'N/A', 'distributor' );
	}

	return $output;
}

/**
 * Get and format external connections.
 *
 * @return array
 */
function get_formatted_external_connnections() {

	$output = [];

	$external_connections = new \WP_Query(
		array(
			'post_type'      => 'dt_ext_connection',
			'fields'         => 'ids',
			'no_found_rows'  => true,
			'posts_per_page' => 100,
		)
	);

	if ( empty( $external_connections->posts ) ) {
		return __( 'N/A', 'distributor' );
	}

	foreach ( $external_connections->posts as $external_connection_id ) {
		$external_connection_type          = get_post_meta( $external_connection_id, 'dt_external_connection_type', true );
		$external_connection_status        = get_post_meta( $external_connection_id, 'dt_external_connections', true );
		$external_connection_allowed_roles = get_post_meta( $external_connection_id, 'dt_external_connection_allowed_roles', true );

		if ( empty( Connections::factory()->get_registered()[ $external_connection_type ] ) ) {
			continue;
		}

		if ( empty( $external_connection_status ) || empty( $external_connection_status['can_get'] ) ) {
			continue;
		}

		$external_connection = ExternalConnection::instantiate( $external_connection_id );

		if ( is_wp_error( $external_connection ) ) {
			continue;
		}

		$data = [
			__( 'URL', 'distributor' )                   => $external_connection->base_url,
			__( 'Version', 'distributor' )               => get_external_connection_version( $external_connection->base_url ),
			__( 'Status', 'distributor' )                => get_external_connection_status( $external_connection_status ),
			__( 'Auth method', 'distributor' )           => 'wp' === $external_connection_type ? __( 'Username / Password', 'distributor' ) : __( 'WordPress.com Application', 'distributor' ),
			__( 'Username', 'distributor' )              => $external_connection->auth_handler->username,
			__( 'Roles Allowed to Push', 'distributor' ) => implode( ', ', $external_connection_allowed_roles ),
			__( 'Additional data', 'distributor' )       => preg_replace( '/,"/', ', "', wp_json_encode( $external_connection_status ) ),
		];

		$output[ $external_connection->name ] = format_connection_data( $data );
	}

	return $output;
}

/**
 * Get external connection version.
 *
 * @param string $url Remote site REST base URL.
 *
 * @return string Remote Distributor version.
 */
function get_external_connection_version( $url ) {
	$route = trailingslashit( $url ) . 'wp/v2/dt_meta';

	// phpcs:ignore WordPressVIPMinimum.Performance.RemoteRequestTimeout.timeout_timeout
	$response = Utils\remote_http_request( $route, [ 'timeout' => 5 ] );
	$body     = json_decode( wp_remote_retrieve_body( $response ), true );

	if ( empty( $body['version'] ) ) {
		return __( 'N/A', 'distributor' );
	}

	return $body['version'];
}

/**
 * Get external connection status.
 *
 * @param array $external_connection_status External connection status meta.
 */
function get_external_connection_status( $external_connection_status ) {
	$status = __( 'valid', 'distributor' );

	if ( empty( $external_connection_status ) ) {
		$status = __( 'error', 'distributor' );
	} else {
		if ( ! empty( $external_connection_status['errors'] ) &amp;&amp; ! empty( $external_connection_status['errors']['no_distributor'] ) ) {
			$status = __( 'error', 'distributor' );
		}

		if ( empty( $external_connection_status['can_post'] ) ) {
			$status = __( 'warning', 'distributor' );
		}
	}

	return $status;
}

/**
 * Format connection data for displaying.
 *
 * @param array $data Assoc array of connection data.
 */
function format_connection_data( $data ) {
	$formatted = array_map(
		function( $key, $value ) {
			return sprintf( '- %1$s: %2$s', $key, $value );
		},
		array_keys( $data ),
		$data
	);

	return "\n" . implode( "\n", $formatted );
}
</code></pre>
        </article>
    </section>





    <footer>
		<a href="https://distributorplugin.com/">Distributor Plugin</a> &bull;
		<a href="https://github.com/10up/distributor/">Distributor on GitHub</a> &bull;
		<a href="https://10up.com/careers">Careers at 10up</a>
	</footer>

</div>

<nav>
	
	<h2><a href="index.html">Home</a></h2><h3>Tutorials</h3><ul><li><a href="tutorial-connect-to-an-existing-post.html">Connect to an Existing Post</a></li><li><a href="tutorial-exclude-meta-from-yoast-duplicate-post.html">Exclude Meta from Yoast Duplicate Post</a></li><li><a href="tutorial-migration-guide-version-1-to-version-2.html">Migration Guide Version 1 to Version 2</a></li><li><a href="tutorial-post-meta.html">Post Meta</a></li><li><a href="tutorial-snippets.html">Snippets</a></li></ul><h3>Actions</h3><ul><li><a href="dt_after_set_meta.html">dt_after_set_meta</a></li><li><a href="dt_before_set_meta.html">dt_before_set_meta</a></li><li><a href="dt_link_post.html">dt_link_post</a></li><li><a href="dt_log_sync.html">dt_log_sync</a></li><li><a href="dt_oauth_admin_notices.html">dt_oauth_admin_notices</a></li><li><a href="dt_prepared_taxonomy_terms.html">dt_prepared_taxonomy_terms</a></li><li><a href="dt_process_distributor_attributes.html">dt_process_distributor_attributes</a></li><li><a href="dt_process_subscription_attributes.html">dt_process_subscription_attributes</a></li><li><a href="dt_pull_filters.html">dt_pull_filters</a></li><li><a href="dt_pull_list_table_custom_column.html">dt_pull_list_table_custom_column</a></li><li><a href="dt_pull_post.html">dt_pull_post</a></li><li><a href="dt_push_external_post.html">dt_push_external_post</a></li><li><a href="dt_push_network_post.html">dt_push_network_post</a></li><li><a href="dt_push_post.html">dt_push_post</a></li><li><a href="dt_unlink_post.html">dt_unlink_post</a></li></ul><h3>Filters</h3><ul><li><a href="distributable_post_types.html">distributable_post_types</a></li><li><a href="distributor_get_original_site_link.html">distributor_get_original_site_link</a></li><li><a href="dt_ajax_requires_with_credentials.html">dt_ajax_requires_with_credentials</a></li><li><a href="dt_allow_post_unlink.html">dt_allow_post_unlink</a></li><li><a href="dt_allowed_media_extensions.html">dt_allowed_media_extensions</a></li><li><a href="dt_auth_format_get_args.html">dt_auth_format_get_args</a></li><li><a href="dt_auth_format_post_args.html">dt_auth_format_post_args</a></li><li><a href="dt_auth_prepare_credentials.html">dt_auth_prepare_credentials</a></li><li><a href="dt_authorized_sites.html">dt_authorized_sites</a></li><li><a href="dt_available_pull_post_types.html">dt_available_pull_post_types</a></li><li><a href="dt_available_push_post_types.html">dt_available_push_post_types</a></li><li><a href="dt_capabilities.html">dt_capabilities</a></li><li><a href="dt_create_missing_terms.html">dt_create_missing_terms</a></li><li><a href="dt_debug_info_enabled.html">dt_debug_info_enabled</a></li><li><a href="dt_distributable_post_statuses.html">dt_distributable_post_statuses</a></li><li><a href="dt_excluded_meta.html">dt_excluded_meta</a></li><li><a href="dt_external_capabilities.html">dt_external_capabilities</a></li><li><a href="dt_get_media_details.html">dt_get_media_details</a></li><li><a href="dt_get_pull_content_rest_query_args.html">dt_get_pull_content_rest_query_args</a></li><li><a href="dt_get_rest_url.html">dt_get_rest_url</a></li><li><a href="dt_item_mapping.html">dt_item_mapping</a></li><li><a href="dt_media_item_formatted.html">dt_media_item_formatted</a></li><li><a href="dt_media_processing_filename.html">dt_media_processing_filename</a></li><li><a href="dt_network_site_connection_enabled.html">dt_network_site_connection_enabled</a></li><li><a href="dt_parse_media_blocks.html">dt_parse_media_blocks</a></li><li><a href="dt_pre_get_authorized_sites.html">dt_pre_get_authorized_sites</a></li><li><a href="dt_prepared_meta.html">dt_prepared_meta</a></li><li><a href="dt_process_media_args.html">dt_process_media_args</a></li><li><a href="dt_process_media_save_source_file_path.html">dt_process_media_save_source_file_path</a></li><li><a href="dt_pull_as_draft.html">dt_pull_as_draft</a></li><li><a href="dt_pull_capabilities.html">dt_pull_capabilities</a></li><li><a href="dt_pull_list_table_columns.html">dt_pull_list_table_columns</a></li><li><a href="dt_pull_list_table_tr_class.html">dt_pull_list_table_tr_class</a></li><li><a href="dt_pull_post_apply_rendered_content.html">dt_pull_post_apply_rendered_content</a></li><li><a href="dt_pull_post_args.html">dt_pull_post_args</a></li><li><a href="dt_pull_post_media.html">dt_pull_post_media</a></li><li><a href="dt_pull_post_meta.html">dt_pull_post_meta</a></li><li><a href="dt_pull_post_terms.html">dt_pull_post_terms</a></li><li><a href="dt_push_capabilities.html">dt_push_capabilities</a></li><li><a href="dt_push_post_args.html">dt_push_post_args</a></li><li><a href="dt_push_post_media.html">dt_push_post_media</a></li><li><a href="dt_push_post_meta.html">dt_push_post_meta</a></li><li><a href="dt_push_post_terms.html">dt_push_post_terms</a></li><li><a href="dt_push_post_timeout.html">dt_push_post_timeout</a></li><li><a href="dt_remote_get.html">dt_remote_get</a></li><li><a href="dt_remote_post.html">dt_remote_post</a></li><li><a href="dt_remote_post_query_args.html">dt_remote_post_query_args</a></li><li><a href="dt_remote_post_timeout.html">dt_remote_post_timeout</a></li><li><a href="dt_set_media_args.html">dt_set_media_args</a></li><li><a href="dt_subscription_post_args.html">dt_subscription_post_args</a></li><li><a href="dt_subscription_post_timeout.html">dt_subscription_post_timeout</a></li><li><a href="dt_sync_media_delete_and_replace.html">dt_sync_media_delete_and_replace</a></li><li><a href="dt_sync_meta.html">dt_sync_meta</a></li><li><a href="dt_syncable_taxonomies.html">dt_syncable_taxonomies</a></li><li><a href="dt_syndicatable_capabilities.html">dt_syndicatable_capabilities</a></li><li><a href="dt_update_content_via_request_args.html">dt_update_content_via_request_args</a></li><li><a href="dt_update_term_hierarchy.html">dt_update_term_hierarchy</a></li><li><a href="dt_use_block_editor_for_post_type.html">dt_use_block_editor_for_post_type</a></li></ul>
</nav>

<br class="clear">

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
