<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: includes/classes/ExternalConnection.php - 10up Distributor Hook Docs</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">

	<link href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono|IBM+Plex+Sans:300,400|Playfair+Display:900&display=swap" rel="stylesheet"> 
    <link type="text/css" rel="stylesheet" href="styles-10up.css">
</head>

<body>

<div id="main">

	
    <h1 class="page-title">Source: includes/classes/ExternalConnection.php</h1>
	

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>&lt;?php
/**
 * External connection base
 *
 * @package  distributor
 */

namespace Distributor;

use \Distributor\Connection as Connection;

/**
 * External connections extend this base abstract class. External onnections are used to push and pull content.
 * Note that static methods are used for interacting with the type whereas class instances
 * deal with an actual connection.
 */
abstract class ExternalConnection extends Connection {

	/**
	 * Title of external connection
	 *
	 * @var string
	 */
	public $name;

	/**
	 * API url for external connection
	 *
	 * @var string
	 */
	public $base_url;

	/**
	 * External connection ID
	 *
	 * @var int
	 */
	public $id;

	/**
	 * Auth handler class
	 *
	 * @var string
	 */
	public $auth_handler;

	/**
	 * Initialize an external connection given a name, url, auth handler, and mapping handler
	 *
	 * @param string         $name Pretty name of connection.
	 * @param string         $base_url URL to connection API.
	 * @param int            $id ID of external connection.
	 * @param Authentication $auth_handler Auth handler class.
	 * @since  0.8
	 */
	public function __construct( $name, $base_url, $id, Authentication $auth_handler ) {
		$this->name         = $name;
		$this->id           = $id;
		$this->base_url     = $base_url;
		$this->auth_handler = $auth_handler;
	}

	/**
	 * Log a sync.
	 *
	 * {
	 *  old_post_id: new_post_id (false means skipped)
	 * }
	 *
	 * This let's us grab all the IDs of posts we've PULLED from a given connection
	 *
	 * @param array   $item_id_mappings Mapping array to store; key = origin post ID, value = new post ID.
	 * @param int     $connection_id Connection ID.
	 * @param boolean $overwrite Whether to overwrite the sync log for this connection. Default false.
	 * @since 0.8
	 */
	public function log_sync( array $item_id_mappings, $connection_id = 0, $overwrite = false ) {
		$connection_id = 0 === $connection_id ? $this->id : $connection_id;

		$sync_log = $this->get_sync_log( $connection_id );

		if ( true === $overwrite ) {
			$sync_log = array();
		}

		foreach ( $item_id_mappings as $old_item_id => $new_item_id ) {
			if ( empty( $new_item_id ) ) {
				$sync_log[ $old_item_id ] = false;
			} else {
				$sync_log[ $old_item_id ] = (int) $new_item_id;
			}
		}

		update_post_meta( $connection_id, 'dt_sync_log', $sync_log );

		/**
		 * Action fired when a sync is being logged.
		 *
		 * @since 1.0
		 * @hook dt_log_sync
		 *
		 * @param {array} $item_id_mappings Item ID mappings.
		 * @param {array} $sync_log The sync log
		 * @param {object} $this The current connection class.
		 */
		do_action( 'dt_log_sync', $item_id_mappings, $sync_log, $this );
	}

	/**
	 * Return the sync log for a specific connection
	 *
	 * @param int $connection_id Connection ID.
	 * @return array
	 */
	public function get_sync_log( $connection_id = 0 ) {
		$connection_id = 0 === $connection_id ? $this->id : $connection_id;

		$sync_log = get_post_meta( $connection_id, 'dt_sync_log', true );

		if ( empty( $sync_log ) ) {
			$sync_log = [];
		}

		return $sync_log;
	}

	/**
	 * Check push/pull connections for the external connection
	 *
	 * @since  0.8
	 * @return array
	 */
	abstract public function check_connections();

	/**
	 * This is a static factory method for initializing an external connection
	 *
	 * @param  int|WP_Post $external_connection External connection reference.
	 * @since  0.8
	 * @return Connection
	 */
	public static function instantiate( $external_connection ) {
		$external_connection_id = $external_connection;

		if ( is_object( $external_connection_id ) &amp;&amp; ! empty( $external_connection_id->ID ) ) {
			$external_connection_id = $external_connection_id->ID;
		}

		$type = get_post_meta( $external_connection_id, 'dt_external_connection_type', true );
		$url  = get_post_meta( $external_connection_id, 'dt_external_connection_url', true );
		$auth = get_post_meta( $external_connection_id, 'dt_external_connection_auth', true );
		$name = get_the_title( $external_connection_id );

		if ( empty( $type ) || empty( $url ) ) {
			return new \WP_Error( 'external_connection_not_found', esc_html__( 'External connection not found.', 'distributor' ) );
		}

		$connections = \Distributor\Connections::factory()->get_registered( 'external' );

		if ( empty( $connections[ $type ] ) ) {
			return new \WP_Error( 'no_external_connection_type', esc_html__( 'External connection type is not registered.', 'distributor' ) );
		}

		$connection_class = $connections[ $type ];

		$auth_handler = new $connection_class::$auth_handler_class( $auth );

		return new $connection_class( $name, $url, $external_connection_id, $auth_handler );
	}
}
</code></pre>
        </article>
    </section>





    <footer>
		<a href="https://distributorplugin.com/">Distributor Plugin</a> &bull;
		<a href="https://github.com/10up/distributor/">Distributor on GitHub</a> &bull;
		<a href="https://10up.com/careers">Careers at 10up</a>
	</footer>

	
</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Actions</h3><ul><li><a href="dt_after_set_meta.html">dt_after_set_meta</a></li><li><a href="dt_link_post.html">dt_link_post</a></li><li><a href="dt_log_sync.html">dt_log_sync</a></li><li><a href="dt_oauth_admin_notices.html">dt_oauth_admin_notices</a></li><li><a href="dt_process_distributor_attributes.html">dt_process_distributor_attributes</a></li><li><a href="dt_process_subscription_attributes.html">dt_process_subscription_attributes</a></li><li><a href="dt_pull_filters.html">dt_pull_filters</a></li><li><a href="dt_pull_list_table_custom_column.html">dt_pull_list_table_custom_column</a></li><li><a href="dt_pull_post.html">dt_pull_post</a></li><li><a href="dt_push_post.html">dt_push_post</a></li><li><a href="dt_unlink_post.html">dt_unlink_post</a></li></ul><h3>Filters</h3><ul><li><a href="distributable_post_types.html">distributable_post_types</a></li><li><a href="distributor_get_original_site_link.html">distributor_get_original_site_link</a></li><li><a href="dt_ajax_requires_with_credentials.html">dt_ajax_requires_with_credentials</a></li><li><a href="dt_allow_post_unlink.html">dt_allow_post_unlink</a></li><li><a href="dt_allowed_media_extensions.html">dt_allowed_media_extensions</a></li><li><a href="dt_auth_format_get_args.html">dt_auth_format_get_args</a></li><li><a href="dt_auth_format_post_args.html">dt_auth_format_post_args</a></li><li><a href="dt_auth_prepare_credentials.html">dt_auth_prepare_credentials</a></li><li><a href="dt_authorized_sites.html">dt_authorized_sites</a></li><li><a href="dt_available_pull_post_types.html">dt_available_pull_post_types</a></li><li><a href="dt_blacklisted_meta.html">dt_blacklisted_meta</a></li><li><a href="dt_capabilities.html">dt_capabilities</a></li><li><a href="dt_create_missing_terms.html">dt_create_missing_terms</a></li><li><a href="dt_debug_info_enabled.html">dt_debug_info_enabled</a></li><li><a href="dt_distributable_post_statuses.html">dt_distributable_post_statuses</a></li><li><a href="dt_external_capabilities.html">dt_external_capabilities</a></li><li><a href="dt_get_media_details.html">dt_get_media_details</a></li><li><a href="dt_get_pull_content_rest_query_args.html">dt_get_pull_content_rest_query_args</a></li><li><a href="dt_get_rest_url.html">dt_get_rest_url</a></li><li><a href="dt_item_mapping.html">dt_item_mapping</a></li><li><a href="dt_media_item_formatted.html">dt_media_item_formatted</a></li><li><a href="dt_media_processing_filename.html">dt_media_processing_filename</a></li><li><a href="dt_network_site_connection_enabled.html">dt_network_site_connection_enabled</a></li><li><a href="dt_pre_get_authorized_sites.html">dt_pre_get_authorized_sites</a></li><li><a href="dt_process_media_args.html">dt_process_media_args</a></li><li><a href="dt_process_media_save_source_file_path.html">dt_process_media_save_source_file_path</a></li><li><a href="dt_pull_as_draft.html">dt_pull_as_draft</a></li><li><a href="dt_pull_capabilities.html">dt_pull_capabilities</a></li><li><a href="dt_pull_list_table_columns.html">dt_pull_list_table_columns</a></li><li><a href="dt_pull_list_table_tr_class.html">dt_pull_list_table_tr_class</a></li><li><a href="dt_pull_post_apply_rendered_content.html">dt_pull_post_apply_rendered_content</a></li><li><a href="dt_pull_post_args.html">dt_pull_post_args</a></li><li><a href="dt_pull_post_media.html">dt_pull_post_media</a></li><li><a href="dt_pull_post_meta.html">dt_pull_post_meta</a></li><li><a href="dt_pull_post_terms.html">dt_pull_post_terms</a></li><li><a href="dt_push_capabilities.html">dt_push_capabilities</a></li><li><a href="dt_push_post_args.html">dt_push_post_args</a></li><li><a href="dt_push_post_media.html">dt_push_post_media</a></li><li><a href="dt_push_post_meta.html">dt_push_post_meta</a></li><li><a href="dt_push_post_terms.html">dt_push_post_terms</a></li><li><a href="dt_push_post_timeout.html">dt_push_post_timeout</a></li><li><a href="dt_remote_get.html">dt_remote_get</a></li><li><a href="dt_remote_get_query_args.html">dt_remote_get_query_args</a></li><li><a href="dt_remote_get_url.html">dt_remote_get_url</a></li><li><a href="dt_remote_post.html">dt_remote_post</a></li><li><a href="dt_remote_post_query_args.html">dt_remote_post_query_args</a></li><li><a href="dt_remote_post_timeout.html">dt_remote_post_timeout</a></li><li><a href="dt_set_media_args.html">dt_set_media_args</a></li><li><a href="dt_subscription_post_args.html">dt_subscription_post_args</a></li><li><a href="dt_subscription_post_timeout.html">dt_subscription_post_timeout</a></li><li><a href="dt_sync_media_delete_and_replace.html">dt_sync_media_delete_and_replace</a></li><li><a href="dt_sync_meta.html">dt_sync_meta</a></li><li><a href="dt_syncable_taxonomies.html">dt_syncable_taxonomies</a></li><li><a href="dt_syndicatable_capabilities.html">dt_syndicatable_capabilities</a></li><li><a href="dt_update_content_via_request_args.html">dt_update_content_via_request_args</a></li><li><a href="dt_update_term_hierarchy.html">dt_update_term_hierarchy</a></li><li><a href="dt_use_block_editor_for_post_type.html">dt_use_block_editor_for_post_type</a></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-snippets.html">snippets</a></li></ul>
</nav>

<br class="clear">

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
