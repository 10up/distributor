(()=>{"use strict";var t={n:e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return t.d(n,{a:n}),n},d:(e,n)=>{for(var a in n)t.o(n,a)&&!t.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:n[a]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};const e=window.jQuery;var n=t.n(e);const a=window._;var r=t.n(a);const i=window.wp.url,o=window.wp.a11y,s=window.wp.i18n;function l(t,e){const n=c(t),a=c(e),r=n.pop(),i=a.pop(),o=h(n,a);return 0!==o?o:r&&i?h(r.split("."),i.split(".")):r||i?r?-1:1:0}const d=(t,e,n)=>{y(n);const a=l(t,e);return b[n].includes(a)};l.validate=t=>"string"==typeof t&&/^[v\d]/.test(t)&&u.test(t),l.compare=d,l.satisfies=(t,e)=>{const n=e.match(/^([<>=~^]+)/),a=n?n[1]:"=";if("^"!==a&&"~"!==a)return d(t,e,a);const[r,i,o]=c(t),[s,l,u]=c(e);return 0===g(r,s)&&("^"===a?h([i,o],[l,u])>=0:0===g(i,l)&&g(o,u)>=0)};const u=/^[v^~<>=]*?(\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+))?(?:-([\da-z\-]+(?:\.[\da-z\-]+)*))?(?:\+[\da-z\-]+(?:\.[\da-z\-]+)*)?)?)?$/i,c=t=>{if("string"!=typeof t)throw new TypeError("Invalid argument expected string");const e=t.match(u);if(!e)throw new Error(`Invalid argument not valid semver ('${t}' received)`);return e.shift(),e},p=t=>"*"===t||"x"===t||"X"===t,_=t=>{const e=parseInt(t,10);return isNaN(e)?t:e},g=(t,e)=>{if(p(t)||p(e))return 0;const[n,a]=((t,e)=>typeof t!=typeof e?[String(t),String(e)]:[t,e])(_(t),_(e));return n>a?1:n<a?-1:0},h=(t,e)=>{for(let n=0;n<Math.max(t.length,e.length);n++){const a=g(t[n]||0,e[n]||0);if(0!==a)return a}return 0},b={">":[1],">=":[0,1],"=":[0],"<=":[-1,0],"<":[-1]},m=Object.keys(b),y=t=>{if("string"!=typeof t)throw new TypeError("Invalid operator type, expected string but got "+typeof t);if(-1===m.indexOf(t))throw new Error(`Invalid operator, expected one of ${m.join("|")}`)},{ajaxurl:v,alert:f,document:w,dt:x,history:E}=window,{body:I}=w,k=w.getElementById("dt_external_connection_url"),B=w.getElementById("dt_external_connection_details"),T=w.getElementById("dt_external_connection_type"),A=w.getElementsByClassName("auth-field"),C=w.getElementsByClassName("dt-roles-allowed"),D=w.getElementById("title"),O=w.querySelector(".endpoint-result"),$=w.querySelector(".endpoint-errors"),j=w.getElementById("post_ID"),z=w.getElementById("create-connection"),N=w.getElementById("wpbody"),P=w.getElementById("dt_external_site_url"),S=w.getElementsByClassName("dt-wizard-error"),[q]=w.getElementsByClassName("dt-wizard-status"),L=w.getElementsByClassName("establish-connection-button"),R=w.getElementById("begin-authorization"),U=w.getElementById("create-oauth-connection"),Q=w.getElementsByClassName("manual-setup-button"),F=w.getElementById("#title-prompt-text"),H=T.value;let M=!1;function W(){if(!1!==M&&M.abort(),""===k.value)return $.innerText="",O.innerText="",void O.removeAttribute("data-endpoint-state");O.setAttribute("data-endpoint-state","loading"),O.innerText=(0,s.__)("Checking endpointâ€¦","distributor"),$.innerText="";const t={};r().each(A,(e=>{if(e.disabled)return;const n=e.getAttribute("data-auth-field");n&&(t[n]=e.value)}));let e=0;j&&j.value&&(e=j.value),M=n().ajax({url:v,method:"post",data:{nonce:x.nonce,action:"dt_verify_external_connection",auth:t,url:k.value,type:T.value,endpointId:e}}).done((t=>{if(t.success)if(t.data.errors.no_external_connection||"no"===t.data.is_authenticated||t.data.errors.no_distributor||!t.data.can_post.length)if(O.setAttribute("data-endpoint-state","error"),t.data.endpoint_suggestion){O.innerText=`${(0,s.__)("Did you mean: ","distributor")} `;const e=w.createElement("button");e.classList.add("suggest"),e.classList.add("button-link"),e.setAttribute("type","button"),e.innerText=t.data.endpoint_suggestion,O.appendChild(e),(0,o.speak)(`${(0,s.__)("Did you mean: ","distributor")} ${t.data.endpoint_suggestion}`,"polite")}else t.data.errors.no_distributor?(O.innerText=(0,s.__)("Distributor not installed on remote site.","distributor"),(0,o.speak)((0,s.__)("Distributor not installed on remote site.","distributor"),"polite")):"no"===t.data.is_authenticated||t.data.errors.no_types?(O.innerText=(0,s.__)("Authentication failed due to insufficient or invalid credentials.","distributor"),(0,o.speak)((0,s.__)("Authentication failed due to insufficient or invalid credentials.","distributor"),"polite")):(O.innerText=(0,s.__)("No connection found.","distributor"),(0,o.speak)((0,s.__)("No connection found.","distributor"),"polite"));else O.setAttribute("data-endpoint-state","valid"),O.innerText=(0,s.__)("Connection established.","distributor"),(0,o.speak)((0,s.__)("Connection established.","distributor"),"polite");else O.setAttribute("data-endpoint-state","error")})).always((()=>{O.classList.remove("loading")}))}N.className=H,n()("#post").on("keypress",(function(t){return!(13===t.which&&!I.classList.contains("post-php")&&("wp"===n()(T).val()&&n()(L).trigger("click"),"wpdotcom"===n()(T).val()&&(rt(R)||n()(R).trigger("click"),rt(U)||n()(U).trigger("click")),1))})),n()(L).on("click",(t=>{t.preventDefault(),n()(S[0]).text("");const e=tt(n()(D),t),a=tt(n()(P),t);if(!e||!a)return t.preventDefault(),!1;let r=(0,i.prependHTTP)(P.value);return(0,i.isURL)(r)?(q.style.display="block",r=r.replace(/wp-json(\/)*/,""),r=r.replace(/\/?$/,"/"),n().ajax({url:v,method:"post",data:{nonce:x.nonce,action:"dt_get_remote_info",url:r}}).done((t=>{if(q.style.display="none",!t.success)return Object.prototype.hasOwnProperty.call(t,"data")&&Object.prototype.hasOwnProperty.call(t.data,"rest_url")&&!Object.prototype.hasOwnProperty.call(t.data,"version")?void n()(S[0]).text((0,s.__)("Distributor not installed on remote site.","distributor")):(n()(S[0]).text((0,s.__)("Distributor not installed on remote site.","distributor")),void(Object.prototype.hasOwnProperty.call(t,"data")&&Array.isArray(t.data)&&0<t.data.length&&Object.prototype.hasOwnProperty.call(t.data[0],"code")&&Object.prototype.hasOwnProperty.call(t.data[0],"message")&&(n()(S[0]).append("<br/>"),t.data.forEach((t=>{n()(S[0]).append(`${t.message} ${t.code?`(${t.code})`:""} <br/>`)})))));if(l.compare(t.data.version,"1.6.0","<"))return void n()(S[0]).text((0,s.__)("Remote site requires Distributor version 1.6.0 or greater. Upgrade Distributor on the remote site to use the Authentication Wizard.","distributor"));if("core_application_passwords_available"in t.data&&!t.data.core_application_passwords_available)return void n()(S[0]).text((0,s.__)("Application Passwords is not available on the remote site. Please set up connection manually!","distributor"));const e=(0,i.addQueryArgs)(w.location.href,{setupStatus:"success",titleField:D.value,externalSiteUrlField:r,restRoot:t.data.rest_url}),a=(0,i.addQueryArgs)(w.location.href,{setupStatus:"failure"}),o="core_has_application_passwords"in t.data&&t.data.core_has_application_passwords?"authorize-application.php":"admin.php?page=auth_app";let d;d="core_application_passwords_endpoint"in t.data&&t.data.core_application_passwords_available?t.data.core_application_passwords_endpoint:`${r}wp-admin/${o}`;const u=(0,i.addQueryArgs)(d,{app_name:(0,s.sprintf)((0,s.__)("Distributor on %1$s (%2$s)","distributor"),x.blog_name,x.home_url),success_url:encodeURI(e),reject_url:encodeURI(a)});w.location=u})),!1):(n()(S[0]).text((0,s.__)("Please enter a valid URL, including the HTTP(S).","distributor")),!1)})),n()(Q).on("click",(t=>{t.preventDefault(),n()(".external-connection-wizard").hide(),n()(".external-connection-setup, .hide-until-authed").show()})),setTimeout((()=>{const{wizard_return:t}=x;t&&(""===D.value&&(n()(D).val(t.titleField).focus().blur(),n()(F).empty()),n()(G).val(t.user_login),n()(X).val(t.password),n()(k).val(t.restRoot),N.className="wizard-return",z.click()),W()}),300),n()(B).on("click",".suggest",(t=>{k.value=t.currentTarget.innerText,n()(k).trigger("input")})),n()(k).on("focus click",(t=>{t.target.setAttribute("initial-url",t.target.value)})),n()(k).on("keyup input",r().debounce((()=>{k.value.replace(/\/$/,"")!==k.getAttribute("initial-url").replace(/\/$/,"")&&(k.setAttribute("initial-url",k.value),W())}),250)),n()(k).on("blur",(t=>{""===D.value&&""!==t.currentTarget.value&&(D.value=t.currentTarget.value.replace(/https?:\/\//i,""),D.focus(),D.blur())}));const X=w.getElementById("dt_password"),G=w.getElementById("dt_username"),J=w.querySelector(".change-password");n()(G).on("focus click",(t=>{t.target.setAttribute("initial-username",t.target.value)})),n()(G).on("keyup input",r().debounce((()=>{G.getAttribute("initial-username")!==G.value&&J&&(X.disabled=!1,X.value="",J.style.display="none")}),250)),n()(X).on("keyup input",r().debounce((()=>{W()}),250)),n()(J).on("click",(t=>{t.preventDefault(),X.disabled?(X.disabled=!1,X.value="",t.currentTarget.innerText=(0,s.__)("Cancel","distributor")):(X.disabled=!0,X.value="sdfdsfsdfdsfdsfsd",t.currentTarget.innerText=(0,s.__)("Change","distributor")),W()})),n()(C).on("click",".dt-role-checkbox",(t=>{t.target.classList.contains("dt-role-checkbox")&&t.target.checked&&"administrator"!==t.target.value&&"editor"!==t.target.value&&f((0,s.__)("Be careful assigning less trusted roles push privileges as they will inherit the capabilities of the user on the remote site.","distributor"))}));const K=n()(".hide-until-authed"),V=n()(w.getElementById("dt_client_secret")),Y=n()(w.getElementById("dt_client_id")),Z=()=>{0===w.getElementsByClassName("oauth-connection-established").length&&K.hide()},tt=(t,e)=>""===t.val()?(e.preventDefault(),t.addClass("error-required"),!1):(t.removeClass("error-required"),!0);n()(T).on("change",(()=>{const t=T.value;N.className=t,"wp"===t?n()(".external-connection-wizard").show():n()(".external-connection-setup, .hide-until-authed").hide()})),"wpdotcom"===T.value&&Z(),U&&n()(U).on("click",(t=>{const e=tt(V,t),n=tt(Y,t);if(!e||!n)return t.preventDefault(),!1}));const et=w.getElementById("oauth-authentication-change-credentials"),nt=n()(".oauth-authentication-details-wrapper");et&&n()(et).on("click",(function(){nt.show(),V.val(""),n()(".oauth-connection-established").remove(),Z()}));const at=w.getElementById("begin-authorization");function rt(t){return null===t.offsetParent}at&&n()(at).on("click",(t=>{const e=n()(D),a=e.val();tt(e,t)&&(n()(at).addClass("disabled"),e.removeClass("error-required"),n().ajax({url:v,method:"post",data:{nonce:x.nonce,action:"dt_begin_authorization",title:a,id:n()(w.getElementById("post_ID")).val()}}).done((t=>{if(t.success&&t.data.id){const e=`${x.admin_url}post.php?post=${t.data.id}&action=edit`;E.pushState({},"Oauth Authorize Details",e),n()(w.getElementById("dt_redirect_uri")).val(e),n()(w.getElementById("dt_created_post_id")).val(t.data.id),n()(w.getElementById("original_post_status")).val("publish"),n()(".oauth-begin-authentication-wrapper").hide(),nt.show()}})).always((()=>{n()(at).removeClass("disabled")})))}))})();